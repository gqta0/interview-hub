<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Multithreading & Concurrency - Java Core Interview</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
    <link rel="stylesheet" href="../css/style.css">
</head>

<body>
    <div class="bg-animation"></div>

    <nav class="top-nav">
        <div class="nav-container">
            <a href="../index.html" class="nav-logo"><i class="fas fa-rocket"></i><span>Interview Hub</span></a>
            <a href="../index.html#java" class="nav-back"><i class="fas fa-arrow-left"></i> Java Core</a>
        </div>
    </nav>

    <header class="topic-header">
        <div class="topic-icon java"><i class="fas fa-sync-alt"></i></div>
        <div class="topic-info">
            <span class="topic-category">Java Core</span>
            <h1>Multithreading & Concurrency</h1>
            <p class="topic-desc">Thread management, synchronization, v√† concurrent utilities</p>
        </div>
    </header>

    <main class="content-container">
        <aside class="toc">
            <h3><i class="fas fa-list"></i> N·ªôi dung</h3>
            <ul>
                <li><a href="#thread-basics">Thread Basics</a></li>
                <li><a href="#thread-lifecycle">Thread Lifecycle</a></li>
                <li><a href="#synchronization">Synchronization</a></li>
                <li><a href="#volatile">Volatile & Atomic</a></li>
                <li><a href="#locks">Locks (ReentrantLock)</a></li>
                <li><a href="#executor">ExecutorService</a></li>
                <li><a href="#completable">CompletableFuture</a></li>
                <li><a href="#forkjoin">Fork/Join Framework</a></li>
                <li><a href="#virtual-threads">Virtual Threads (Java 21)</a></li>
                <li><a href="#problems">Common Problems</a></li>
                <li><a href="#interview">C√¢u h·ªèi ph·ªèng v·∫•n</a></li>
            </ul>
        </aside>

        <article class="main-content">
            <!-- THREAD BASICS -->
            <section class="content-section">
                <h2 id="thread-basics" class="section-title"><span class="section-icon">üßµ</span>Thread Basics</h2>

                <div class="concept-card">
                    <div class="concept-header">
                        <h3>T·∫°o Thread trong Java</h3>
                        <span class="badge essential">Essential</span>
                    </div>
                    <div class="concept-content">
                        <div class="code-block">
                            <div class="code-header"><span class="code-lang">Java</span><span class="code-title">4 c√°ch
                                    t·∫°o Thread</span></div>
                            <pre><code class="language-java">// 1. Extend Thread class
class MyThread extends Thread {
    @Override
    public void run() {
        System.out.println("Thread: " + Thread.currentThread().getName());
    }
}
new MyThread().start();

// 2. Implement Runnable (∆Øu ti√™n - cho ph√©p extends class kh√°c)
class MyRunnable implements Runnable {
    @Override
    public void run() {
        System.out.println("Runnable ƒëang ch·∫°y");
    }
}
new Thread(new MyRunnable()).start();

// 3. Lambda (Java 8+)
new Thread(() -> System.out.println("Lambda thread")).start();

// 4. Callable (tr·∫£ v·ªÅ gi√° tr·ªã, c√≥ th·ªÉ throw exception)
Callable&lt;String&gt; callable = () -> {
    return "K·∫øt qu·∫£";
};
ExecutorService executor = Executors.newSingleThreadExecutor();
Future&lt;String&gt; future = executor.submit(callable);
String result = future.get();  // Blocks cho ƒë·∫øn khi ho√†n th√†nh</code></pre>
                        </div>

                        <div class="comparison-table">
                            <h4>Runnable vs Callable</h4>
                            <table>
                                <thead>
                                    <tr>
                                        <th>Feature</th>
                                        <th>Runnable</th>
                                        <th>Callable</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><strong>Return value</strong></td>
                                        <td>void</td>
                                        <td>V (generic)</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Exception</strong></td>
                                        <td>Kh√¥ng throw checked</td>
                                        <td>C√≥ th·ªÉ throw Exception</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Method</strong></td>
                                        <td>run()</td>
                                        <td>call()</td>
                                    </tr>
                                    <tr>
                                        <td><strong>D√πng v·ªõi</strong></td>
                                        <td>Thread, Executor</td>
                                        <td>Ch·ªâ ExecutorService</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <div class="warning-box">
                            <h4><i class="fas fa-exclamation-triangle"></i> start() vs run()</h4>
                            <ul>
                                <li><strong>start():</strong> T·∫°o thread m·ªõi, JVM g·ªçi run() trong thread ƒë√≥</li>
                                <li><strong>run():</strong> Ch·ªâ g·ªçi method b√¨nh th∆∞·ªùng, KH√îNG t·∫°o thread m·ªõi!</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </section>

            <!-- THREAD LIFECYCLE -->
            <section class="content-section">
                <h2 id="thread-lifecycle" class="section-title"><span class="section-icon">üîÑ</span>Thread Lifecycle
                </h2>

                <div class="concept-card">
                    <div class="concept-content">
                        <div class="code-block">
                            <div class="code-header"><span class="code-lang">Diagram</span></div>
                            <pre><code>    NEW ‚îÄ‚îÄstart()‚îÄ‚îÄ> RUNNABLE ‚îÄ‚îÄrun complete‚îÄ‚îÄ> TERMINATED
                          ‚îÇ ‚Üë
                          ‚îÇ ‚îÇ
             wait/sleep   ‚Üì ‚îÇ  notify/interrupt/time
                     WAITING/TIMED_WAITING
                          ‚îÇ ‚Üë
                          ‚îÇ ‚îÇ
             synchronized ‚Üì ‚îÇ  lock acquired
                       BLOCKED</code></pre>
                        </div>

                        <div class="comparison-table">
                            <h4>Thread States (Thread.State enum)</h4>
                            <table>
                                <thead>
                                    <tr>
                                        <th>State</th>
                                        <th>M√¥ t·∫£</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><code>NEW</code></td>
                                        <td>Thread ƒë∆∞·ª£c t·∫°o nh∆∞ng ch∆∞a start()</td>
                                    </tr>
                                    <tr>
                                        <td><code>RUNNABLE</code></td>
                                        <td>ƒêang ch·∫°y ho·∫∑c s·∫µn s√†ng ch·∫°y</td>
                                    </tr>
                                    <tr>
                                        <td><code>BLOCKED</code></td>
                                        <td>ƒêang ch·ªù monitor lock</td>
                                    </tr>
                                    <tr>
                                        <td><code>WAITING</code></td>
                                        <td>wait(), join() kh√¥ng timeout</td>
                                    </tr>
                                    <tr>
                                        <td><code>TIMED_WAITING</code></td>
                                        <td>sleep(), wait(timeout), join(timeout)</td>
                                    </tr>
                                    <tr>
                                        <td><code>TERMINATED</code></td>
                                        <td>Ho√†n th√†nh execution</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <div class="code-block">
                            <div class="code-header"><span class="code-lang">Java</span><span class="code-title">C√°c
                                    method quan tr·ªçng</span></div>
                            <pre><code class="language-java">// sleep() - pause thread hi·ªán t·∫°i
Thread.sleep(1000);  // RUNNABLE ‚Üí TIMED_WAITING

// join() - ch·ªù thread kh√°c ho√†n th√†nh
thread.join();       // Thread hi·ªán t·∫°i ch·ªù 'thread' k·∫øt th√∫c
thread.join(5000);   // Ch·ªù t·ªëi ƒëa 5 gi√¢y

// wait/notify - giao ti·∫øp gi·ªØa c√°c threads
synchronized(lock) {
    while (!condition) {
        lock.wait();     // Nh·∫£ lock v√† ch·ªù
    }
    // Ti·∫øp t·ª•c khi ƒë∆∞·ª£c notify
}

synchronized(lock) {
    condition = true;
    lock.notify();   // ƒê√°nh th·ª©c 1 thread ƒëang wait
    lock.notifyAll(); // ƒê√°nh th·ª©c t·∫•t c·∫£
}

// interrupt() - y√™u c·∫ßu thread d·ª´ng
thread.interrupt();  // Set interrupt flag
// Trong thread:
if (Thread.interrupted()) { // Clears flag
    // X·ª≠ l√Ω interrupt
}

// yield() - g·ª£i √Ω scheduler cho thread kh√°c ch·∫°y
Thread.yield();  // Kh√¥ng ƒë·∫£m b·∫£o g√¨ c·∫£</code></pre>
                        </div>
                    </div>
                </div>
            </section>

            <!-- SYNCHRONIZATION -->
            <section class="content-section">
                <h2 id="synchronization" class="section-title"><span class="section-icon">üîê</span>Synchronization</h2>

                <div class="concept-card">
                    <div class="concept-header">
                        <h3>synchronized Keyword</h3>
                        <span class="badge essential">Essential</span>
                    </div>
                    <div class="concept-content">
                        <div class="code-block">
                            <div class="code-header"><span class="code-lang">Java</span><span class="code-title">C√°c
                                    lo·∫°i Synchronization</span></div>
                            <pre><code class="language-java">public class Counter {
    private int count = 0;
    
    // 1. Synchronized method - kh√≥a 'this' object
    public synchronized void increment() {
        count++;  // Ch·ªâ 1 thread v√†o ƒë∆∞·ª£c t·∫°i m·ªôt th·ªùi ƒëi·ªÉm
    }
    
    // 2. Synchronized block - kh√≥a object c·ª• th·ªÉ
    public void incrementWithBlock() {
        synchronized(this) {
            count++;
        }
    }
    
    // 3. Static synchronized - kh√≥a Class object
    private static int staticCount = 0;
    public static synchronized void staticIncrement() {
        staticCount++;  // Kh√≥a Counter.class
    }
    
    // 4. Kh√≥a tr√™n object ri√™ng (t·ªët h∆°n)
    private final Object lock = new Object();
    public void incrementWithLock() {
        synchronized(lock) {
            count++;
        }
    }
}</code></pre>
                        </div>

                        <div class="info-box">
                            <h4><i class="fas fa-lightbulb"></i> Best Practices</h4>
                            <ul>
                                <li>D√πng private final Object ƒë·ªÉ l√†m lock</li>
                                <li>Gi·ªØ synchronized block nh·ªè nh·∫•t c√≥ th·ªÉ</li>
                                <li>Kh√¥ng synchronized tr√™n String literals ho·∫∑c boxed primitives</li>
                                <li>ƒê·∫£m b·∫£o nh·∫•t qu√°n v·ªÅ lock ordering ƒë·ªÉ tr√°nh deadlock</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </section>

            <!-- VOLATILE & ATOMIC -->
            <section class="content-section">
                <h2 id="volatile" class="section-title"><span class="section-icon">‚ö°</span>Volatile & Atomic</h2>

                <div class="concept-card">
                    <div class="concept-content">
                        <div class="two-column">
                            <div class="column highlight-box">
                                <h4>volatile</h4>
                                <ul>
                                    <li>Ch·ªâ ƒë·∫£m b·∫£o <strong>visibility</strong></li>
                                    <li>Kh√¥ng ƒë·∫£m b·∫£o atomicity</li>
                                    <li>ƒê·ªçc/ghi tr·ª±c ti·∫øp t·ª´ main memory</li>
                                    <li>D√πng cho: boolean flags, status</li>
                                </ul>
                            </div>
                            <div class="column highlight-box">
                                <h4>Atomic Classes</h4>
                                <ul>
                                    <li>Visibility + <strong>Atomicity</strong></li>
                                    <li>Lock-free d√πng CAS (Compare-And-Swap)</li>
                                    <li>AtomicInteger, AtomicLong, AtomicReference</li>
                                    <li>D√πng cho: counters, accumulators</li>
                                </ul>
                            </div>
                        </div>

                        <div class="code-block">
                            <div class="code-header"><span class="code-lang">Java</span><span
                                    class="code-title">Volatile vs Atomic</span></div>
                            <pre><code class="language-java">// volatile - ch·ªâ visibility
private volatile boolean running = true;
// OK cho flag
public void stop() { running = false; }

private volatile int count = 0;
count++;  // ‚ùå KH√îNG ATOMIC! (read ‚Üí increment ‚Üí write)

// AtomicInteger - visibility + atomicity
private AtomicInteger atomicCount = new AtomicInteger(0);
atomicCount.incrementAndGet();  // ‚úÖ ATOMIC (CAS operation)

// C√°c operations ph·ªï bi·∫øn
atomicCount.get();
atomicCount.set(10);
atomicCount.compareAndSet(expected, newValue);  // CAS
atomicCount.getAndAdd(5);
atomicCount.updateAndGet(x -> x * 2);
atomicCount.accumulateAndGet(10, Integer::sum);

// AtomicReference cho objects
AtomicReference&lt;User&gt; userRef = new AtomicReference&lt;&gt;(user);
userRef.compareAndSet(oldUser, newUser);</code></pre>
                        </div>

                        <div class="comparison-table">
                            <h4>Khi n√†o d√πng g√¨?</h4>
                            <table>
                                <thead>
                                    <tr>
                                        <th>Scenario</th>
                                        <th>Solution</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>Boolean flag (stop, running)</td>
                                        <td>volatile</td>
                                    </tr>
                                    <tr>
                                        <td>Counter (increment, decrement)</td>
                                        <td>AtomicInteger</td>
                                    </tr>
                                    <tr>
                                        <td>Nhi·ªÅu bi·∫øn c·∫≠p nh·∫≠t c√πng l√∫c</td>
                                        <td>synchronized</td>
                                    </tr>
                                    <tr>
                                        <td>Read-heavy, √≠t write</td>
                                        <td>ReadWriteLock</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- LOCKS -->
            <section class="content-section">
                <h2 id="locks" class="section-title"><span class="section-icon">üîí</span>Locks</h2>

                <div class="concept-card">
                    <div class="concept-header">
                        <h3>ReentrantLock</h3>
                        <span class="badge important">Important</span>
                    </div>
                    <div class="concept-content">
                        <div class="comparison-table">
                            <h4>ReentrantLock vs synchronized</h4>
                            <table>
                                <thead>
                                    <tr>
                                        <th>Feature</th>
                                        <th>synchronized</th>
                                        <th>ReentrantLock</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><strong>Try lock</strong></td>
                                        <td>‚ùå</td>
                                        <td>‚úÖ tryLock()</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Timeout</strong></td>
                                        <td>‚ùå</td>
                                        <td>‚úÖ tryLock(time, unit)</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Interruptible</strong></td>
                                        <td>‚ùå</td>
                                        <td>‚úÖ lockInterruptibly()</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Fairness</strong></td>
                                        <td>‚ùå</td>
                                        <td>‚úÖ new ReentrantLock(true)</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Multiple conditions</strong></td>
                                        <td>‚ùå</td>
                                        <td>‚úÖ newCondition()</td>
                                    </tr>
                                    <tr>
                                        <td><strong>T·ª± ƒë·ªông release</strong></td>
                                        <td>‚úÖ</td>
                                        <td>‚ùå Ph·∫£i unlock trong finally</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <div class="code-block">
                            <div class="code-header"><span class="code-lang">Java</span><span
                                    class="code-title">ReentrantLock Usage</span></div>
                            <pre><code class="language-java">private final ReentrantLock lock = new ReentrantLock();

public void safeMethod() {
    lock.lock();  // L·∫•y lock
    try {
        // Critical section
    } finally {
        lock.unlock();  // LU√îN release trong finally!
    }
}

// Try lock v·ªõi timeout - tr√°nh deadlock
if (lock.tryLock(1, TimeUnit.SECONDS)) {
    try {
        // L·∫•y ƒë∆∞·ª£c lock
    } finally {
        lock.unlock();
    }
} else {
    // Kh√¥ng l·∫•y ƒë∆∞·ª£c lock, x·ª≠ l√Ω kh√°c
}

// ReadWriteLock cho read-heavy workloads
ReadWriteLock rwLock = new ReentrantReadWriteLock();

// Nhi·ªÅu threads ƒë·ªçc ƒë·ªìng th·ªùi
rwLock.readLock().lock();
try {
    // Read operations
} finally {
    rwLock.readLock().unlock();
}

// Ch·ªâ 1 thread write t·∫°i m·ªôt th·ªùi ƒëi·ªÉm
rwLock.writeLock().lock();
try {
    // Write operations
} finally {
    rwLock.writeLock().unlock();
}</code></pre>
                        </div>

                        <div class="code-block">
                            <div class="code-header"><span class="code-lang">Java</span><span
                                    class="code-title">StampedLock (Java 8)</span></div>
                            <pre><code class="language-java">// StampedLock - optimistic reading
StampedLock sl = new StampedLock();

// Optimistic read - kh√¥ng block writers
long stamp = sl.tryOptimisticRead();
// ƒê·ªçc data
int currentX = x;
int currentY = y;
// Validate stamp - c√≥ writer n√†o chen v√†o kh√¥ng?
if (!sl.validate(stamp)) {
    // C√≥ writer, ph·∫£i l·∫•y read lock th·ª±c s·ª±
    stamp = sl.readLock();
    try {
        currentX = x;
        currentY = y;
    } finally {
        sl.unlockRead(stamp);
    }
}

// Write lock
long stamp = sl.writeLock();
try {
    x = newX;
    y = newY;
} finally {
    sl.unlockWrite(stamp);
}</code></pre>
                        </div>
                    </div>
                </div>
            </section>

            <!-- EXECUTOR SERVICE -->
            <section class="content-section">
                <h2 id="executor" class="section-title"><span class="section-icon">‚öôÔ∏è</span>ExecutorService</h2>

                <div class="concept-card">
                    <div class="concept-header">
                        <h3>Thread Pool Types</h3>
                        <span class="badge essential">Essential</span>
                    </div>
                    <div class="concept-content">
                        <div class="comparison-table">
                            <table>
                                <thead>
                                    <tr>
                                        <th>Pool Type</th>
                                        <th>Core/Max</th>
                                        <th>Queue</th>
                                        <th>Use Case</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td>newFixedThreadPool(n)</td>
                                        <td>n / n</td>
                                        <td>Unbounded</td>
                                        <td>S·ªë task bi·∫øt tr∆∞·ªõc</td>
                                    </tr>
                                    <tr>
                                        <td>newCachedThreadPool()</td>
                                        <td>0 / MAX</td>
                                        <td>SynchronousQueue</td>
                                        <td>Task ng·∫Øn, burst</td>
                                    </tr>
                                    <tr>
                                        <td>newSingleThreadExecutor()</td>
                                        <td>1 / 1</td>
                                        <td>Unbounded</td>
                                        <td>Tu·∫ßn t·ª±</td>
                                    </tr>
                                    <tr>
                                        <td>newScheduledThreadPool(n)</td>
                                        <td>n / MAX</td>
                                        <td>DelayQueue</td>
                                        <td>Scheduled/periodic</td>
                                    </tr>
                                    <tr>
                                        <td>newWorkStealingPool()</td>
                                        <td>CPU cores</td>
                                        <td>Per-thread</td>
                                        <td>Parallel, Fork/Join</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <div class="code-block">
                            <div class="code-header"><span class="code-lang">Java</span><span
                                    class="code-title">ExecutorService Usage</span></div>
                            <pre><code class="language-java">// T·∫°o thread pool
ExecutorService executor = Executors.newFixedThreadPool(4);

// Submit tasks
executor.execute(() -> System.out.println("Runnable"));  // Kh√¥ng return
Future&lt;String&gt; future = executor.submit(() -> "Callable result");  // Return Future

// L·∫•y k·∫øt qu·∫£ (blocking)
String result = future.get();
String resultWithTimeout = future.get(5, TimeUnit.SECONDS);

// Check status
future.isDone();
future.isCancelled();
future.cancel(true);  // mayInterruptIfRunning

// Submit nhi·ªÅu tasks
List&lt;Callable&lt;String&gt;&gt; tasks = Arrays.asList(
    () -> "Task 1",
    () -> "Task 2"
);
List&lt;Future&lt;String&gt;&gt; futures = executor.invokeAll(tasks);  // Ch·ªù t·∫•t c·∫£
String firstResult = executor.invokeAny(tasks);  // Ch·ªù 1 c√°i ƒë·∫ßu ti√™n xong

// ‚ö†Ô∏è LU√îN shutdown!
executor.shutdown();  // Graceful - ch·ªù tasks hi·ªán t·∫°i
executor.shutdownNow();  // Immediate - interrupt t·∫•t c·∫£
executor.awaitTermination(10, TimeUnit.SECONDS);</code></pre>
                        </div>

                        <div class="code-block">
                            <div class="code-header"><span class="code-lang">Java</span><span class="code-title">Custom
                                    ThreadPoolExecutor</span></div>
                            <pre><code class="language-java">// T·∫°o custom thread pool
ThreadPoolExecutor executor = new ThreadPoolExecutor(
    4,                  // corePoolSize - threads lu√¥n gi·ªØ
    10,                 // maximumPoolSize - max threads
    60L,                // keepAliveTime - idle time tr∆∞·ªõc khi kill
    TimeUnit.SECONDS,
    new LinkedBlockingQueue&lt;&gt;(100),  // work queue
    new ThreadFactory() {  // custom thread names
        @Override
        public Thread newThread(Runnable r) {
            Thread t = new Thread(r);
            t.setName("MyPool-" + t.getId());
            return t;
        }
    },
    new ThreadPoolExecutor.CallerRunsPolicy()  // rejection handler
);

// Rejection policies:
// AbortPolicy (default) - throws RejectedExecutionException
// CallerRunsPolicy - caller thread runs the task
// DiscardPolicy - silently discard
// DiscardOldestPolicy - discard oldest in queue</code></pre>
                        </div>
                    </div>
                </div>
            </section>

            <!-- COMPLETABLE FUTURE -->
            <section class="content-section">
                <h2 id="completable" class="section-title"><span class="section-icon">üöÄ</span>CompletableFuture</h2>

                <div class="concept-card">
                    <div class="concept-header">
                        <h3>Async Programming (Java 8+)</h3>
                        <span class="badge important">Important</span>
                    </div>
                    <div class="concept-content">
                        <div class="code-block">
                            <div class="code-header"><span class="code-lang">Java</span><span
                                    class="code-title">CompletableFuture Patterns</span></div>
                            <pre><code class="language-java">// T·∫°o async task
CompletableFuture&lt;String&gt; future = CompletableFuture.supplyAsync(() -> {
    // Ch·∫°y trong ForkJoinPool.commonPool()
    return "Hello";
});

// V·ªõi custom executor
CompletableFuture&lt;String&gt; future = CompletableFuture.supplyAsync(
    () -> "Hello",
    myExecutor
);

// Chain transformations
future.thenApply(s -> s + " World")           // Transform result
      .thenAccept(System.out::println)        // Consume result (void)
      .thenRun(() -> System.out.println("Done")); // Run after (void)

// Async variants (ch·∫°y trong thread kh√°c)
future.thenApplyAsync(s -> s + " World")
      .thenAcceptAsync(System.out::println);</code></pre>
                        </div>

                        <div class="code-block">
                            <div class="code-header"><span class="code-lang">Java</span><span
                                    class="code-title">Combining Futures</span></div>
                            <pre><code class="language-java">CompletableFuture&lt;String&gt; f1 = CompletableFuture.supplyAsync(() -> "Hello");
CompletableFuture&lt;String&gt; f2 = CompletableFuture.supplyAsync(() -> "World");

// Combine khi c·∫£ 2 complete
CompletableFuture&lt;String&gt; combined = f1.thenCombine(f2, (s1, s2) -> s1 + " " + s2);

// Ch·ªù t·∫•t c·∫£ complete
CompletableFuture.allOf(f1, f2).join();

// Ch·ªù 1 trong c√°c futures complete
CompletableFuture&lt;Object&gt; any = CompletableFuture.anyOf(f1, f2);

// Error handling
future.exceptionally(ex -> "Default")
      .handle((result, ex) -> {
          if (ex != null) return "Error: " + ex.getMessage();
          return result;
      });

// Real-world pattern: parallel API calls
List&lt;CompletableFuture&lt;Product&gt;&gt; futures = productIds.stream()
    .map(id -> CompletableFuture.supplyAsync(() -> fetchProduct(id)))
    .collect(toList());

List&lt;Product&gt; products = futures.stream()
    .map(CompletableFuture::join)
    .collect(toList());</code></pre>
                        </div>
                    </div>
                </div>
            </section>

            <!-- FORK/JOIN -->
            <section class="content-section">
                <h2 id="forkjoin" class="section-title"><span class="section-icon">üç¥</span>Fork/Join Framework</h2>

                <div class="concept-card">
                    <div class="concept-header">
                        <h3>Divide and Conquer</h3>
                        <span class="badge important">Important</span>
                    </div>
                    <div class="concept-content">
                        <p>Fork/Join framework d√πng cho c√°c task c√≥ th·ªÉ chia nh·ªè (divide-and-conquer). Work-stealing
                            algorithm gi√∫p load balancing.</p>

                        <div class="code-block">
                            <div class="code-header"><span class="code-lang">Java</span><span
                                    class="code-title">RecursiveTask Example</span></div>
                            <pre><code class="language-java">// RecursiveTask&lt;V&gt; - c√≥ return value
class SumTask extends RecursiveTask&lt;Long&gt; {
    private final long[] array;
    private final int start, end;
    private static final int THRESHOLD = 1000;
    
    public SumTask(long[] array, int start, int end) {
        this.array = array;
        this.start = start;
        this.end = end;
    }
    
    @Override
    protected Long compute() {
        int length = end - start;
        
        // Base case: ƒë·ªß nh·ªè th√¨ t√≠nh tr·ª±c ti·∫øp
        if (length <= THRESHOLD) {
            long sum = 0;
            for (int i = start; i < end; i++) {
                sum += array[i];
            }
            return sum;
        }
        
        // Recursive case: chia ƒë√¥i
        int mid = start + length / 2;
        SumTask left = new SumTask(array, start, mid);
        SumTask right = new SumTask(array, mid, end);
        
        left.fork();  // Submit left task to pool
        Long rightResult = right.compute();  // Compute right in current thread
        Long leftResult = left.join();  // Wait for left result
        
        return leftResult + rightResult;
    }
}

// S·ª≠ d·ª•ng
ForkJoinPool pool = ForkJoinPool.commonPool();
long sum = pool.invoke(new SumTask(array, 0, array.length));

// RecursiveAction - kh√¥ng return value
class SortTask extends RecursiveAction {
    @Override
    protected void compute() {
        // Similar pattern but no return
    }
}</code></pre>
                        </div>
                    </div>
                </div>
            </section>

            <!-- VIRTUAL THREADS -->
            <section class="content-section">
                <h2 id="virtual-threads" class="section-title"><span class="section-icon">üåê</span>Virtual Threads (Java
                    21)</h2>

                <div class="concept-card">
                    <div class="concept-header">
                        <h3>Lightweight Threads</h3>
                        <span class="badge advanced">Advanced</span>
                    </div>
                    <div class="concept-content">
                        <p>Virtual Threads l√† lightweight threads ƒë∆∞·ª£c qu·∫£n l√Ω b·ªüi JVM, kh√¥ng ph·∫£i OS. C√≥ th·ªÉ t·∫°o h√†ng
                            tri·ªáu virtual threads!</p>

                        <div class="comparison-table">
                            <h4>Platform Threads vs Virtual Threads</h4>
                            <table>
                                <thead>
                                    <tr>
                                        <th>Feature</th>
                                        <th>Platform Thread</th>
                                        <th>Virtual Thread</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><strong>Managed by</strong></td>
                                        <td>OS</td>
                                        <td>JVM</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Stack size</strong></td>
                                        <td>~1MB</td>
                                        <td>~KB (grows as needed)</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Max count</strong></td>
                                        <td>~Thousands</td>
                                        <td>Millions</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Scheduling</strong></td>
                                        <td>OS scheduler</td>
                                        <td>JVM scheduler</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Blocking cost</strong></td>
                                        <td>Expensive</td>
                                        <td>Cheap (unmount)</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Use case</strong></td>
                                        <td>CPU-bound</td>
                                        <td>I/O-bound</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <div class="code-block">
                            <div class="code-header"><span class="code-lang">Java</span><span class="code-title">Virtual
                                    Threads Usage</span></div>
                            <pre><code class="language-java">// T·∫°o virtual thread
Thread vThread = Thread.ofVirtual().start(() -> {
    System.out.println("Virtual thread: " + Thread.currentThread());
});

// Named virtual thread
Thread named = Thread.ofVirtual()
    .name("my-virtual-thread")
    .start(() -> doWork());

// Virtual thread executor (t·ªët nh·∫•t cho I/O-bound tasks)
try (var executor = Executors.newVirtualThreadPerTaskExecutor()) {
    // M·ªói task ch·∫°y trong 1 virtual thread m·ªõi
    IntStream.range(0, 10_000).forEach(i -> {
        executor.submit(() -> {
            Thread.sleep(1000);  // Cheap blocking!
            return i;
        });
    });
}  // Auto shutdown v·ªõi try-with-resources

// Structured Concurrency (Preview in Java 21)
try (var scope = new StructuredTaskScope.ShutdownOnFailure()) {
    Future&lt;User&gt; user = scope.fork(() -> fetchUser(id));
    Future&lt;List&lt;Order&gt;&gt; orders = scope.fork(() -> fetchOrders(id));
    
    scope.join();           // Wait for both
    scope.throwIfFailed();  // Propagate exceptions
    
    return new Response(user.resultNow(), orders.resultNow());
}</code></pre>
                        </div>

                        <div class="warning-box">
                            <h4><i class="fas fa-exclamation-triangle"></i> Virtual Threads Best Practices</h4>
                            <ul>
                                <li><strong>D√πng cho I/O-bound:</strong> HTTP calls, DB queries, file I/O</li>
                                <li><strong>Kh√¥ng d√πng cho CPU-bound:</strong> Virtual threads v·∫´n map l√™n platform
                                    threads</li>
                                <li><strong>Avoid synchronized:</strong> D√πng ReentrantLock thay th·∫ø (virtual thread b·ªã
                                    pin khi synchronized)</li>
                                <li><strong>Kh√¥ng pool:</strong> T·∫°o m·ªõi cho m·ªói task, kh√¥ng reuse</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </section>

            <!-- COMMON PROBLEMS -->
            <section class="content-section">
                <h2 id="problems" class="section-title"><span class="section-icon">‚ö†Ô∏è</span>Common Problems</h2>

                <div class="concept-card">
                    <div class="concept-header">
                        <h3>Deadlock, Livelock, Starvation</h3>
                        <span class="badge essential">Essential</span>
                    </div>
                    <div class="concept-content">
                        <div class="code-block">
                            <div class="code-header"><span class="code-lang">Java</span><span
                                    class="code-title">Deadlock Example</span></div>
                            <pre><code class="language-java">// DEADLOCK: Thread 1 gi·ªØ lock1, ch·ªù lock2
//           Thread 2 gi·ªØ lock2, ch·ªù lock1

Object lock1 = new Object();
Object lock2 = new Object();

// Thread 1
synchronized(lock1) {
    synchronized(lock2) { /* work */ }
}

// Thread 2
synchronized(lock2) {
    synchronized(lock1) { /* work */ }  // DEADLOCK!
}

// ‚úÖ SOLUTION 1: Lock ordering - lu√¥n l·∫•y lock theo th·ª© t·ª±
synchronized(lock1) {
    synchronized(lock2) { /* work */ }
}

// ‚úÖ SOLUTION 2: tryLock v·ªõi timeout
if (lock1.tryLock(1, TimeUnit.SECONDS)) {
    try {
        if (lock2.tryLock(1, TimeUnit.SECONDS)) {
            try {
                // work
            } finally { lock2.unlock(); }
        }
    } finally { lock1.unlock(); }
}</code></pre>
                        </div>

                        <div class="comparison-table">
                            <h4>Deadlock vs Livelock vs Starvation</h4>
                            <table>
                                <thead>
                                    <tr>
                                        <th>Problem</th>
                                        <th>M√¥ t·∫£</th>
                                        <th>Solution</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><strong>Deadlock</strong></td>
                                        <td>Threads ch·ªù nhau m√£i m√£i</td>
                                        <td>Lock ordering, tryLock timeout</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Livelock</strong></td>
                                        <td>Threads ph·∫£n ·ª©ng l·∫´n nhau, kh√¥ng progress</td>
                                        <td>Random delay, back-off</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Starvation</strong></td>
                                        <td>Thread kh√¥ng bao gi·ªù ƒë∆∞·ª£c CPU time</td>
                                        <td>Fair lock, priority adjustment</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- INTERVIEW QUESTIONS -->
            <section id="interview" class="content-section">
                <h2 class="section-title"><span class="section-icon">üíº</span>C√¢u H·ªèi Ph·ªèng V·∫•n</h2>

                <div class="interview-questions">
                    <div class="question-card">
                        <div class="question"><span class="q-number">Q1</span>
                            <p>S·ª± kh√°c bi·ªát gi·ªØa synchronized v√† ReentrantLock?</p>
                        </div>
                        <div class="answer">
                            <p><strong>ReentrantLock</strong> cung c·∫•p: tryLock(), timeout, interruptible locking, fair
                                mode, multiple conditions. Nh∆∞ng ph·∫£i unlock th·ªß c√¥ng trong finally block. synchronized
                                t·ª± ƒë·ªông release khi exit block.</p>
                        </div>
                    </div>
                    <div class="question-card">
                        <div class="question"><span class="q-number">Q2</span>
                            <p>volatile keyword d√πng ƒë·ªÉ l√†m g√¨?</p>
                        </div>
                        <div class="answer">
                            <p>ƒê·∫£m b·∫£o <strong>visibility</strong> - reads/writes ƒëi th·∫≥ng v√†o main memory. KH√îNG ƒë·∫£m
                                b·∫£o atomicity. D√πng cho simple flags, kh√¥ng d√πng cho counter++ (c·∫ßn AtomicInteger).</p>
                        </div>
                    </div>
                    <div class="question-card">
                        <div class="question"><span class="q-number">Q3</span>
                            <p>Thread.sleep() vs Object.wait()?</p>
                        </div>
                        <div class="answer">
                            <ul>
                                <li><strong>sleep():</strong> Pause thread, GI·ªÆ lock, timeout</li>
                                <li><strong>wait():</strong> NH·∫¢ lock v√† ch·ªù notify(). Ph·∫£i trong synchronized block.
                                </li>
                            </ul>
                        </div>
                    </div>
                    <div class="question-card">
                        <div class="question"><span class="q-number">Q4</span>
                            <p>X·ª≠ l√Ω exception trong ExecutorService th·∫ø n√†o?</p>
                        </div>
                        <div class="answer">
                            <p>1) Wrap try-catch trong task. 2) Future.get() throws ExecutionException. 3) Override
                                ThreadPoolExecutor.afterExecute(). 4) Set UncaughtExceptionHandler.</p>
                        </div>
                    </div>
                    <div class="question-card">
                        <div class="question"><span class="q-number">Q5</span>
                            <p>ThreadLocal l√† g√¨?</p>
                        </div>
                        <div class="answer">
                            <p>Bi·∫øn thread-local - m·ªói thread c√≥ b·∫£n copy ri√™ng. D√πng cho: user sessions, DB
                                connections, SimpleDateFormat (not thread-safe). ‚ö†Ô∏è Nh·ªõ g·ªçi remove() ƒë·ªÉ tr√°nh memory
                                leaks!</p>
                        </div>
                    </div>
                    <div class="question-card">
                        <div class="question"><span class="q-number">Q6</span>
                            <p>Virtual Threads kh√°c g√¨ Platform Threads?</p>
                        </div>
                        <div class="answer">
                            <ul>
                                <li><strong>Platform:</strong> OS-managed, ~1MB stack, thousands max, expensive blocking
                                </li>
                                <li><strong>Virtual:</strong> JVM-managed, dynamic stack, millions possible, cheap
                                    blocking</li>
                            </ul>
                            <p>Virtual threads t·ªët cho I/O-bound, platform threads cho CPU-bound.</p>
                        </div>
                    </div>
                    <div class="question-card">
                        <div class="question"><span class="q-number">Q7</span>
                            <p>Deadlock l√† g√¨? C√°ch ph√≤ng tr√°nh?</p>
                        </div>
                        <div class="answer">
                            <p><strong>Deadlock:</strong> 2+ threads ch·ªù nhau m√£i m√£i. <strong>Ph√≤ng tr√°nh:</strong>
                                Lock ordering (lu√¥n l·∫•y locks theo th·ª© t·ª±), tryLock v·ªõi timeout, gi·∫£m s·ªë locks c·∫ßn
                                thi·∫øt.</p>
                        </div>
                    </div>
                    <div class="question-card">
                        <div class="question"><span class="q-number">Q8</span>
                            <p>CompletableFuture vs Future?</p>
                        </div>
                        <div class="answer">
                            <ul>
                                <li><strong>Future:</strong> Ch·ªâ get() blocking, kh√¥ng chain ƒë∆∞·ª£c</li>
                                <li><strong>CompletableFuture:</strong> thenApply, thenCombine, exceptionally,
                                    non-blocking composition</li>
                            </ul>
                        </div>
                    </div>
                    <div class="question-card">
                        <div class="question"><span class="q-number">Q9</span>
                            <p>Fork/Join Framework d√πng cho g√¨?</p>
                        </div>
                        <div class="answer">
                            <p>Divide-and-conquer tasks. Chia task l·ªõn th√†nh subtasks, x·ª≠ l√Ω parallel, merge k·∫øt qu·∫£.
                                Work-stealing algorithm load balance gi·ªØa threads. D√πng RecursiveTask (c√≥ return) ho·∫∑c
                                RecursiveAction (void).</p>
                        </div>
                    </div>
                    <div class="question-card">
                        <div class="question"><span class="q-number">Q10</span>
                            <p>C√°c thread pool trong Executors?</p>
                        </div>
                        <div class="answer">
                            <ul>
                                <li><strong>FixedThreadPool:</strong> n threads c·ªë ƒë·ªãnh, unbounded queue</li>
                                <li><strong>CachedThreadPool:</strong> 0-MAX threads, t·∫°o m·ªõi khi c·∫ßn</li>
                                <li><strong>SingleThreadExecutor:</strong> 1 thread, tu·∫ßn t·ª±</li>
                                <li><strong>ScheduledThreadPool:</strong> Scheduled/periodic tasks</li>
                                <li><strong>Virtual (Java 21):</strong> 1 virtual thread per task</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </section>

            <div class="page-navigation">
                <a href="collections.html" class="nav-btn prev"><i
                        class="fas fa-arrow-left"></i><span>Collections</span></a>
                <a href="jvm-internals.html" class="nav-btn next"><span>JVM Internals</span><i
                        class="fas fa-arrow-right"></i></a>
            </div>
        </article>
    </main>

    <button class="back-to-top" id="backToTop"><i class="fas fa-arrow-up"></i></button>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-java.min.js"></script>
    <script src="../js/main.js"></script>
</body>

</html>