<!DOCTYPE html>
<html lang="vi">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Transactions & ACID - MySQL Interview</title>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/themes/prism-tomorrow.min.css">
    <link rel="stylesheet" href="../css/style.css">
</head>

<body>
    <div class="bg-animation"></div>

    <nav class="top-nav">
        <div class="nav-container">
            <a href="../index.html" class="nav-logo"><i class="fas fa-rocket"></i><span>Interview Hub</span></a>
            <a href="indexing.html" class="nav-back"><i class="fas fa-arrow-left"></i> Indexing</a>
        </div>
    </nav>

    <header class="topic-header">
        <div class="topic-icon mysql"><i class="fas fa-sync"></i></div>
        <div class="topic-info">
            <span class="topic-category">MySQL</span>
            <h1>Transactions & ACID</h1>
            <p class="topic-desc">ACID Properties, Isolation Levels, Locking, MVCC, Deadlocks</p>
        </div>
    </header>

    <main class="content-container">
        <aside class="toc">
            <h3><i class="fas fa-list"></i> N·ªôi dung</h3>
            <ul>
                <li><a href="#acid">ACID Properties</a></li>
                <li><a href="#isolation">Isolation Levels</a></li>
                <li><a href="#phenomena">Read Phenomena</a></li>
                <li><a href="#locking">Locking Mechanisms</a></li>
                <li><a href="#deadlocks">Deadlocks</a></li>
                <li><a href="#mvcc">MVCC</a></li>
                <li><a href="#practical">Practical Examples</a></li>
                <li><a href="#interview">C√¢u h·ªèi ph·ªèng v·∫•n</a></li>
            </ul>
        </aside>

        <article class="main-content">
            <!-- ACID -->
            <section class="content-section">
                <h2 id="acid" class="section-title"><span class="section-icon">‚öõÔ∏è</span>ACID Properties</h2>

                <div class="concept-card">
                    <div class="concept-header">
                        <h3>Transaction Fundamentals</h3><span class="badge essential">Essential</span>
                    </div>
                    <div class="concept-content">
                        <div class="comparison-table">
                            <h4>ACID Properties Explained</h4>
                            <table>
                                <thead>
                                    <tr>
                                        <th>Property</th>
                                        <th>Description</th>
                                        <th>Guarantee</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><strong>A - Atomicity</strong></td>
                                        <td>All or nothing</td>
                                        <td>Transaction ho√†n th√†nh ho√†n to√†n ho·∫∑c rollback ho√†n to√†n</td>
                                    </tr>
                                    <tr>
                                        <td><strong>C - Consistency</strong></td>
                                        <td>Valid state transitions</td>
                                        <td>Database lu√¥n ·ªü tr·∫°ng th√°i h·ª£p l·ªá (constraints, triggers)</td>
                                    </tr>
                                    <tr>
                                        <td><strong>I - Isolation</strong></td>
                                        <td>Concurrent independence</td>
                                        <td>Transactions kh√¥ng th·∫•y uncommitted changes c·ªßa nhau</td>
                                    </tr>
                                    <tr>
                                        <td><strong>D - Durability</strong></td>
                                        <td>Permanent once committed</td>
                                        <td>Committed data survives crashes (write-ahead log)</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <div class="code-block">
                            <div class="code-header"><span class="code-lang">SQL</span><span
                                    class="code-title">Transaction Basics</span></div>
                            <pre><code class="language-sql">-- Start transaction
START TRANSACTION;
-- or
BEGIN;

-- Perform operations
UPDATE accounts SET balance = balance - 100 WHERE id = 1;
UPDATE accounts SET balance = balance + 100 WHERE id = 2;

-- Check before commit
SELECT * FROM accounts WHERE id IN (1, 2);

-- Commit if all successful
COMMIT;

-- Or rollback on error
ROLLBACK;


-- SAVEPOINT for partial rollback
START TRANSACTION;

UPDATE accounts SET balance = balance - 100 WHERE id = 1;
SAVEPOINT sp1;

UPDATE accounts SET balance = balance + 100 WHERE id = 2;
-- Oops, wrong account!

ROLLBACK TO sp1;  -- Only rollback second update

UPDATE accounts SET balance = balance + 100 WHERE id = 3;  -- Correct account
COMMIT;


-- Auto-commit mode (default ON)
SET autocommit = 0;  -- Disable auto-commit
-- Now you must explicitly COMMIT
UPDATE users SET name = 'New Name' WHERE id = 1;
COMMIT;  -- Required!

SET autocommit = 1;  -- Re-enable


-- Transaction with READ ONLY (performance hint)
START TRANSACTION READ ONLY;
SELECT * FROM products WHERE category = 'Electronics';
COMMIT;


-- Transaction with consistent snapshot
START TRANSACTION WITH CONSISTENT SNAPSHOT;
-- All SELECTs see snapshot from this point
SELECT * FROM orders;
-- ... other reads see same snapshot
COMMIT;</code></pre>
                        </div>
                    </div>
                </div>
            </section>

            <!-- ISOLATION LEVELS -->
            <section class="content-section">
                <h2 id="isolation" class="section-title"><span class="section-icon">üîê</span>Isolation Levels</h2>

                <div class="concept-card">
                    <div class="concept-header">
                        <h3>SQL Standard Levels</h3><span class="badge essential">Essential</span>
                    </div>
                    <div class="concept-content">
                        <div class="comparison-table">
                            <h4>Isolation Levels Comparison</h4>
                            <table>
                                <thead>
                                    <tr>
                                        <th>Level</th>
                                        <th>Dirty Read</th>
                                        <th>Non-Repeatable</th>
                                        <th>Phantom</th>
                                        <th>Performance</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><strong>READ UNCOMMITTED</strong></td>
                                        <td>‚úÖ Possible</td>
                                        <td>‚úÖ Possible</td>
                                        <td>‚úÖ Possible</td>
                                        <td>Fastest</td>
                                    </tr>
                                    <tr>
                                        <td><strong>READ COMMITTED</strong></td>
                                        <td>‚ùå Prevented</td>
                                        <td>‚úÖ Possible</td>
                                        <td>‚úÖ Possible</td>
                                        <td>Fast</td>
                                    </tr>
                                    <tr>
                                        <td><strong>REPEATABLE READ</strong></td>
                                        <td>‚ùå Prevented</td>
                                        <td>‚ùå Prevented</td>
                                        <td>‚úÖ Possible*</td>
                                        <td>Moderate</td>
                                    </tr>
                                    <tr>
                                        <td><strong>SERIALIZABLE</strong></td>
                                        <td>‚ùå Prevented</td>
                                        <td>‚ùå Prevented</td>
                                        <td>‚ùå Prevented</td>
                                        <td>Slowest</td>
                                    </tr>
                                </tbody>
                            </table>
                            <p><em>*InnoDB prevents phantom reads with gap locking in REPEATABLE READ</em></p>
                        </div>

                        <div class="code-block">
                            <div class="code-header"><span class="code-lang">SQL</span><span class="code-title">Setting
                                    Isolation Levels</span></div>
                            <pre><code class="language-sql">-- Check current isolation level
SELECT @@transaction_isolation;  -- MySQL 8.0+
SELECT @@tx_isolation;           -- MySQL 5.7

-- Set for session
SET SESSION TRANSACTION ISOLATION LEVEL READ COMMITTED;

-- Set for next transaction only
SET TRANSACTION ISOLATION LEVEL SERIALIZABLE;
START TRANSACTION;
-- ... operations
COMMIT;

-- Set globally (requires privileges)
SET GLOBAL TRANSACTION ISOLATION LEVEL REPEATABLE READ;

-- In my.cnf
transaction-isolation = REPEATABLE-READ</code></pre>
                        </div>

                        <div class="info-box">
                            <h4><i class="fas fa-lightbulb"></i> InnoDB Default: REPEATABLE READ</h4>
                            <ul>
                                <li>MySQL default v√† recommended cho h·∫ßu h·∫øt use cases</li>
                                <li>InnoDB uses gap locking ‚Üí actually prevents phantoms too</li>
                                <li>READ COMMITTED ph·ªï bi·∫øn cho high-concurrency (Oracle default)</li>
                                <li>SERIALIZABLE only khi really need full isolation</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </section>

            <!-- READ PHENOMENA -->
            <section class="content-section">
                <h2 id="phenomena" class="section-title"><span class="section-icon">üëª</span>Read Phenomena</h2>

                <div class="concept-card">
                    <div class="concept-header">
                        <h3>Concurrency Issues</h3><span class="badge essential">Essential</span>
                    </div>
                    <div class="concept-content">
                        <div class="code-block">
                            <div class="code-header"><span class="code-lang">Visual</span><span class="code-title">Dirty
                                    Read</span></div>
                            <pre><code>DIRTY READ: Reading uncommitted data

Transaction A                    Transaction B
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
BEGIN;
UPDATE accounts 
  SET balance = 500 
  WHERE id = 1;
  (was 1000)
                                 BEGIN;
                                 SELECT balance FROM accounts 
                                   WHERE id = 1;
                                 ‚Üí Returns 500 (uncommitted!)
                                 
                                 -- Uses this 500 for calculation
                                 COMMIT;
ROLLBACK;
-- Balance back to 1000

‚ùå Transaction B used wrong data!</code></pre>
                        </div>

                        <div class="code-block">
                            <div class="code-header"><span class="code-lang">Visual</span><span
                                    class="code-title">Non-Repeatable Read</span></div>
                            <pre><code>NON-REPEATABLE READ: Same row, different values

Transaction A                    Transaction B
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
BEGIN;
SELECT balance FROM accounts 
  WHERE id = 1;
‚Üí Returns 1000
                                 BEGIN;
                                 UPDATE accounts 
                                   SET balance = 500 
                                   WHERE id = 1;
                                 COMMIT;
                                 
SELECT balance FROM accounts 
  WHERE id = 1;
‚Üí Returns 500 (different!)

‚ùå Same query, different result within same transaction!</code></pre>
                        </div>

                        <div class="code-block">
                            <div class="code-header"><span class="code-lang">Visual</span><span
                                    class="code-title">Phantom Read</span></div>
                            <pre><code>PHANTOM READ: New rows appear/disappear

Transaction A                    Transaction B
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
BEGIN;
SELECT COUNT(*) FROM orders 
  WHERE status = 'PENDING';
‚Üí Returns 10
                                 BEGIN;
                                 INSERT INTO orders 
                                   (status) VALUES ('PENDING');
                                 COMMIT;
                                 
SELECT COUNT(*) FROM orders 
  WHERE status = 'PENDING';
‚Üí Returns 11 (phantom row!)

‚ùå New row "appeared" during transaction!</code></pre>
                        </div>

                        <div class="comparison-table">
                            <h4>Phenomena Summary</h4>
                            <table>
                                <thead>
                                    <tr>
                                        <th>Phenomenon</th>
                                        <th>Description</th>
                                        <th>Prevented By</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><strong>Dirty Read</strong></td>
                                        <td>Read uncommitted data</td>
                                        <td>READ COMMITTED+</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Non-Repeatable</strong></td>
                                        <td>Same row changes</td>
                                        <td>REPEATABLE READ+</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Phantom</strong></td>
                                        <td>New rows appear</td>
                                        <td>SERIALIZABLE (or InnoDB gap lock)</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </section>

            <!-- LOCKING -->
            <section class="content-section">
                <h2 id="locking" class="section-title"><span class="section-icon">üîí</span>Locking Mechanisms</h2>

                <div class="concept-card">
                    <div class="concept-header">
                        <h3>InnoDB Lock Types</h3><span class="badge essential">Essential</span>
                    </div>
                    <div class="concept-content">
                        <div class="comparison-table">
                            <h4>Lock Types</h4>
                            <table>
                                <thead>
                                    <tr>
                                        <th>Lock Type</th>
                                        <th>Description</th>
                                        <th>Compatible With</th>
                                    </tr>
                                </thead>
                                <tbody>
                                    <tr>
                                        <td><strong>Shared (S)</strong></td>
                                        <td>Read lock</td>
                                        <td>Other S locks</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Exclusive (X)</strong></td>
                                        <td>Write lock</td>
                                        <td>Nothing</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Intention Shared (IS)</strong></td>
                                        <td>Intent to get S lock</td>
                                        <td>IS, IX, S</td>
                                    </tr>
                                    <tr>
                                        <td><strong>Intention Exclusive (IX)</strong></td>
                                        <td>Intent to get X lock</td>
                                        <td>IS, IX</td>
                                    </tr>
                                </tbody>
                            </table>
                        </div>

                        <div class="code-block">
                            <div class="code-header"><span class="code-lang">SQL</span><span class="code-title">Lock
                                    Types in Action</span></div>
                            <pre><code class="language-sql">-- ROW LOCKS (InnoDB default for indexed rows)

-- Shared lock (read lock)
SELECT * FROM accounts WHERE id = 1 FOR SHARE;
-- Others can read, cannot update

-- Exclusive lock (write lock)
SELECT * FROM accounts WHERE id = 1 FOR UPDATE;
-- Others cannot read or update

-- Skip locked rows (for queue processing)
SELECT * FROM jobs WHERE status = 'PENDING' 
LIMIT 1 FOR UPDATE SKIP LOCKED;

-- No wait (fail immediately if locked)
SELECT * FROM accounts WHERE id = 1 FOR UPDATE NOWAIT;


-- GAP LOCK (lock gap between index values)
-- Prevents inserts in the gap
-- Example: WHERE id BETWEEN 10 AND 20
-- Locks: existing rows + gaps between them

-- NEXT-KEY LOCK = Record lock + Gap lock before it
-- InnoDB default for REPEATABLE READ


-- TABLE LOCKS (explicit)
LOCK TABLES accounts READ;   -- Shared table lock
LOCK TABLES accounts WRITE;  -- Exclusive table lock
UNLOCK TABLES;

-- Metadata lock (DDL)
-- Automatic when ALTER TABLE runs


-- View current locks
SELECT * FROM performance_schema.data_locks;
SELECT * FROM information_schema.innodb_locks;  -- Deprecated

-- Lock wait timeout
SET innodb_lock_wait_timeout = 50;  -- seconds</code></pre>
                        </div>

                        <div class="code-block">
                            <div class="code-header"><span class="code-lang">Visual</span><span class="code-title">Gap
                                    Lock Example</span></div>
                            <pre><code>Table has IDs: 10, 20, 30

Query: SELECT * FROM t WHERE id > 15 AND id < 25 FOR UPDATE;

Locks acquired:
‚îú‚îÄ Record lock on id=20
‚îú‚îÄ Gap lock on (10, 20)  ‚Üê Prevents insert of id=15,16,17,18,19
‚îî‚îÄ Gap lock on (20, 30)  ‚Üê Prevents insert of id=21,22,23,24

Another transaction cannot:
‚Ä¢ INSERT id = 15 to 19 (gap locked)
‚Ä¢ INSERT id = 21 to 29 (gap locked)
‚Ä¢ UPDATE id = 20 (record locked)

This prevents phantom reads!</code></pre>
                        </div>
                    </div>
                </div>
            </section>

            <!-- DEADLOCKS -->
            <section class="content-section">
                <h2 id="deadlocks" class="section-title"><span class="section-icon">üíÄ</span>Deadlocks</h2>

                <div class="concept-card">
                    <div class="concept-header">
                        <h3>Deadlock Detection & Prevention</h3><span class="badge essential">Essential</span>
                    </div>
                    <div class="concept-content">
                        <div class="code-block">
                            <div class="code-header"><span class="code-lang">Visual</span><span
                                    class="code-title">Deadlock Scenario</span></div>
                            <pre><code>DEADLOCK: Circular wait

Transaction A                    Transaction B
‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ
BEGIN;
UPDATE accounts SET balance=900 
  WHERE id = 1;
(Locks row 1)
                                 BEGIN;
                                 UPDATE accounts SET balance=900 
                                   WHERE id = 2;
                                 (Locks row 2)

UPDATE accounts SET balance=1100 
  WHERE id = 2;
(Waiting for row 2...)
                                 UPDATE accounts SET balance=1100 
                                   WHERE id = 1;
                                 (Waiting for row 1...)

üíÄ DEADLOCK! Both waiting for each other

InnoDB detects ‚Üí Rolls back one transaction
Error 1213: Deadlock found when trying to get lock</code></pre>
                        </div>

                        <div class="code-block">
                            <div class="code-header"><span class="code-lang">SQL</span><span class="code-title">Deadlock
                                    Handling</span></div>
                            <pre><code class="language-sql">-- View latest deadlock
SHOW ENGINE INNODB STATUS;
-- Look for "LATEST DETECTED DEADLOCK" section

-- Deadlock information
SELECT * FROM information_schema.innodb_metrics 
WHERE name = 'lock_deadlocks';

-- In application code: RETRY on deadlock
-- Pseudocode:
max_retries = 3
for attempt in range(max_retries):
    try:
        start_transaction()
        # ... operations
        commit()
        break
    except DeadlockError:
        rollback()
        if attempt == max_retries - 1:
            raise
        sleep(random_backoff)</code></pre>
                        </div>

                        <div class="key-points">
                            <h4><i class="fas fa-key"></i> Deadlock Prevention Strategies</h4>
                            <ul>
                                <li><strong>Consistent lock order:</strong> Always lock tables/rows in same order</li>
                                <li><strong>Keep transactions short:</strong> Less time holding locks</li>
                                <li><strong>Use appropriate isolation:</strong> Lower isolation = fewer locks</li>
                                <li><strong>Lock all needed rows upfront:</strong> WITH FOR UPDATE at start</li>
                                <li><strong>Use NOWAIT/SKIP LOCKED:</strong> Fail fast instead of waiting</li>
                                <li><strong>Index properly:</strong> Avoid table scans that lock many rows</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </section>

            <!-- MVCC -->
            <section class="content-section">
                <h2 id="mvcc" class="section-title"><span class="section-icon">üì∏</span>MVCC</h2>

                <div class="concept-card">
                    <div class="concept-header">
                        <h3>Multi-Version Concurrency Control</h3><span class="badge important">Important</span>
                    </div>
                    <div class="concept-content">
                        <div class="code-block">
                            <div class="code-header"><span class="code-lang">Visual</span><span class="code-title">MVCC
                                    Concept</span></div>
                            <pre><code>MVCC: Non-blocking reads via versioning

Each row has hidden columns:
‚Ä¢ DB_TRX_ID:    Transaction ID that created/modified
‚Ä¢ DB_ROLL_PTR:  Pointer to undo log (previous version)
‚Ä¢ DB_ROW_ID:    Auto-generated row ID (if no PK)

Row version chain in Undo Log:
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê     ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ Current Row ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫‚îÇ Version N-1 ‚îÇ‚îÄ‚îÄ‚îÄ‚îÄ‚ñ∫‚îÇ Version N-2 ‚îÇ
‚îÇ TRX_ID: 100 ‚îÇ     ‚îÇ TRX_ID: 50  ‚îÇ     ‚îÇ TRX_ID: 25  ‚îÇ
‚îÇ name: 'Bob' ‚îÇ     ‚îÇ name: 'Al'  ‚îÇ     ‚îÇ name: 'A'   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò     ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò

Transaction reads based on snapshot:
‚Ä¢ If TRX_ID > my_snapshot ‚Üí I see older version
‚Ä¢ If TRX_ID <= my_snapshot ‚Üí I see this version
‚Ä¢ If TRX_ID is uncommitted ‚Üí I see older version</code></pre>
                        </div>

                        <div class="two-column">
                            <div class="column highlight-box">
                                <h4>‚úÖ MVCC Benefits</h4>
                                <ul>
                                    <li>Read don't block write</li>
                                    <li>Write don't block read</li>
                                    <li>Consistent reads without locking</li>
                                    <li>Better concurrency</li>
                                </ul>
                            </div>
                            <div class="column highlight-box">
                                <h4>‚ö†Ô∏è MVCC Overhead</h4>
                                <ul>
                                    <li>Undo log storage</li>
                                    <li>Purge thread cleanup</li>
                                    <li>Long transactions = more versions</li>
                                    <li>Version visibility check cost</li>
                                </ul>
                            </div>
                        </div>

                        <div class="code-block">
                            <div class="code-header"><span class="code-lang">SQL</span><span class="code-title">Snapshot
                                    Behavior</span></div>
                            <pre><code class="language-sql">-- REPEATABLE READ: Snapshot at first read
START TRANSACTION;
SELECT * FROM accounts;  -- Snapshot created HERE
-- All subsequent reads see this snapshot
-- Even if other transactions commit changes

-- READ COMMITTED: Fresh snapshot each statement
SET TRANSACTION ISOLATION LEVEL READ COMMITTED;
START TRANSACTION;
SELECT * FROM accounts;  -- Snapshot 1
-- ... other transaction commits
SELECT * FROM accounts;  -- Snapshot 2 (sees committed changes)

-- Consistent read vs Locking read
SELECT * FROM accounts WHERE id = 1;           -- Consistent read (MVCC)
SELECT * FROM accounts WHERE id = 1 FOR UPDATE; -- Current read (locks)</code></pre>
                        </div>
                    </div>
                </div>
            </section>

            <!-- PRACTICAL EXAMPLES -->
            <section class="content-section">
                <h2 id="practical" class="section-title"><span class="section-icon">üí°</span>Practical Examples</h2>

                <div class="concept-card">
                    <div class="concept-header">
                        <h3>Real-World Patterns</h3><span class="badge important">Important</span>
                    </div>
                    <div class="concept-content">
                        <div class="code-block">
                            <div class="code-header"><span class="code-lang">SQL</span><span class="code-title">Bank
                                    Transfer (Classic Example)</span></div>
                            <pre><code class="language-sql">-- Atomic transfer with proper locking
START TRANSACTION;

-- Lock both accounts (order by ID to prevent deadlock)
SELECT balance FROM accounts WHERE id IN (1, 2) FOR UPDATE;

-- Check sufficient balance
SET @from_balance = (SELECT balance FROM accounts WHERE id = 1);
IF @from_balance >= 100 THEN
    UPDATE accounts SET balance = balance - 100 WHERE id = 1;
    UPDATE accounts SET balance = balance + 100 WHERE id = 2;
    COMMIT;
ELSE
    ROLLBACK;
END IF;</code></pre>
                        </div>

                        <div class="code-block">
                            <div class="code-header"><span class="code-lang">SQL</span><span
                                    class="code-title">Inventory Reduction (Avoid Over-selling)</span></div>
                            <pre><code class="language-sql">-- Method 1: Pessimistic locking
START TRANSACTION;
SELECT stock FROM products WHERE id = 123 FOR UPDATE;
-- Check stock >= quantity
UPDATE products SET stock = stock - 5 WHERE id = 123 AND stock >= 5;
IF ROW_COUNT() = 0 THEN
    ROLLBACK;  -- Not enough stock
ELSE
    INSERT INTO orders (...) VALUES (...);
    COMMIT;
END IF;

-- Method 2: Optimistic with check
UPDATE products 
SET stock = stock - 5, version = version + 1
WHERE id = 123 AND stock >= 5 AND version = @expected_version;
-- Check affected rows
IF ROW_COUNT() = 0 THEN
    -- Either insufficient stock or version mismatch
    -- Retry or fail
END IF;</code></pre>
                        </div>

                        <div class="code-block">
                            <div class="code-header"><span class="code-lang">SQL</span><span class="code-title">Job
                                    Queue Processing</span></div>
                            <pre><code class="language-sql">-- Process jobs without blocking
START TRANSACTION;

-- Claim a pending job, skip if locked
SELECT id, payload FROM jobs 
WHERE status = 'PENDING' 
ORDER BY created_at 
LIMIT 1 
FOR UPDATE SKIP LOCKED;

-- Update to processing
UPDATE jobs SET status = 'PROCESSING', worker_id = @worker WHERE id = @job_id;
COMMIT;

-- Process job outside transaction
-- ...

-- Mark complete
UPDATE jobs SET status = 'COMPLETED' WHERE id = @job_id;</code></pre>
                        </div>

                        <div class="code-block">
                            <div class="code-header"><span class="code-lang">SQL</span><span class="code-title">Unique
                                    Counter/Sequence</span></div>
                            <pre><code class="language-sql">-- Table for sequences
CREATE TABLE sequences (
    name VARCHAR(50) PRIMARY KEY,
    value BIGINT NOT NULL DEFAULT 0
);

-- Get next value atomically
START TRANSACTION;
UPDATE sequences SET value = LAST_INSERT_ID(value + 1) WHERE name = 'order_number';
SELECT LAST_INSERT_ID() AS next_val;
COMMIT;

-- Or use INSERT ... ON DUPLICATE KEY
INSERT INTO sequences (name, value) VALUES ('order_number', 1)
ON DUPLICATE KEY UPDATE value = LAST_INSERT_ID(value + 1);
SELECT LAST_INSERT_ID();</code></pre>
                        </div>
                    </div>
                </div>
            </section>

            <!-- INTERVIEW QUESTIONS -->
            <section id="interview" class="content-section">
                <h2 class="section-title"><span class="section-icon">üíº</span>C√¢u H·ªèi Ph·ªèng V·∫•n</h2>

                <div class="interview-questions">
                    <div class="question-card">
                        <div class="question"><span class="q-number">Q1</span>
                            <p>ACID properties l√† g√¨?</p>
                        </div>
                        <div class="answer">
                            <ul>
                                <li><strong>Atomicity:</strong> All or nothing - transaction commit ho√†n to√†n ho·∫∑c
                                    rollback ho√†n to√†n</li>
                                <li><strong>Consistency:</strong> Database lu√¥n ·ªü valid state (constraints satisfied)
                                </li>
                                <li><strong>Isolation:</strong> Concurrent transactions kh√¥ng th·∫•y uncommitted changes
                                </li>
                                <li><strong>Durability:</strong> Committed data persists even after crash (via WAL)</li>
                            </ul>
                        </div>
                    </div>
                    <div class="question-card">
                        <div class="question"><span class="q-number">Q2</span>
                            <p>C√°c isolation levels v√† kh√°c bi·ªát?</p>
                        </div>
                        <div class="answer">
                            <ul>
                                <li><strong>READ UNCOMMITTED:</strong> Dirty reads possible, highest concurrency</li>
                                <li><strong>READ COMMITTED:</strong> No dirty reads, non-repeatable reads possible</li>
                                <li><strong>REPEATABLE READ:</strong> Same row same value, phantoms possible (InnoDB
                                    prevents via gap lock)</li>
                                <li><strong>SERIALIZABLE:</strong> Full isolation, lowest concurrency</li>
                            </ul>
                        </div>
                    </div>
                    <div class="question-card">
                        <div class="question"><span class="q-number">Q3</span>
                            <p>Dirty Read vs Non-Repeatable Read vs Phantom?</p>
                        </div>
                        <div class="answer">
                            <ul>
                                <li><strong>Dirty:</strong> See uncommitted data (T2 reads T1's uncommitted change)</li>
                                <li><strong>Non-Repeatable:</strong> Same row different value (T2 commits between T1's
                                    reads)</li>
                                <li><strong>Phantom:</strong> New rows appear (T2 inserts between T1's range queries)
                                </li>
                            </ul>
                        </div>
                    </div>
                    <div class="question-card">
                        <div class="question"><span class="q-number">Q4</span>
                            <p>MVCC l√† g√¨? T·∫°i sao quan tr·ªçng?</p>
                        </div>
                        <div class="answer">
                            <p>Multi-Version Concurrency Control: m·ªói row c√≥ multiple versions trong undo log. Readers
                                see snapshot (kh√¥ng c·∫ßn lock), writers create new version. Benefits: reads don't block
                                writes, writes don't block reads ‚Üí higher concurrency than locking-only approach.</p>
                        </div>
                    </div>
                    <div class="question-card">
                        <div class="question"><span class="q-number">Q5</span>
                            <p>Gap Lock l√† g√¨? Khi n√†o d√πng?</p>
                        </div>
                        <div class="answer">
                            <p>Lock on gap between index records. Prevents inserts in that range. Used by InnoDB in
                                REPEATABLE READ for range queries to prevent phantom reads. Example:
                                <code>WHERE id > 10 AND id < 20</code> locks gap between existing records in that range.
                            </p>
                        </div>
                    </div>
                    <div class="question-card">
                        <div class="question"><span class="q-number">Q6</span>
                            <p>FOR UPDATE vs FOR SHARE?</p>
                        </div>
                        <div class="answer">
                            <ul>
                                <li><strong>FOR SHARE:</strong> Shared/read lock - others can read, cannot update</li>
                                <li><strong>FOR UPDATE:</strong> Exclusive/write lock - others cannot read or update
                                </li>
                            </ul>
                            <p>Use FOR UPDATE when you plan to update the selected rows. Use FOR SHARE for read
                                consistency.</p>
                        </div>
                    </div>
                    <div class="question-card">
                        <div class="question"><span class="q-number">Q7</span>
                            <p>L√†m sao prevent/handle deadlock?</p>
                        </div>
                        <div class="answer">
                            <ul>
                                <li><strong>Prevention:</strong> Consistent lock order, short transactions, proper
                                    indexing</li>
                                <li><strong>Detection:</strong> InnoDB auto-detects and rolls back one transaction</li>
                                <li><strong>Handling:</strong> Catch error 1213, retry with exponential backoff</li>
                                <li><strong>Diagnosis:</strong> SHOW ENGINE INNODB STATUS for deadlock details</li>
                            </ul>
                        </div>
                    </div>
                    <div class="question-card">
                        <div class="question"><span class="q-number">Q8</span>
                            <p>SKIP LOCKED d√πng khi n√†o?</p>
                        </div>
                        <div class="answer">
                            <p>Job queue processing: multiple workers claim jobs without blocking. SELECT ... FOR UPDATE
                                SKIP LOCKED returns unlocked rows immediately, skipping locked ones. Eliminates wait
                                time. Alternative: NOWAIT fails immediately if any row locked.</p>
                        </div>
                    </div>
                    <div class="question-card">
                        <div class="question"><span class="q-number">Q9</span>
                            <p>Optimistic vs Pessimistic locking?</p>
                        </div>
                        <div class="answer">
                            <ul>
                                <li><strong>Pessimistic:</strong> Lock rows before reading (FOR UPDATE). Safe but lower
                                    concurrency.</li>
                                <li><strong>Optimistic:</strong> No lock, check version/timestamp at update. Higher
                                    concurrency but may need retry on conflict.</li>
                            </ul>
                            <p>Use pessimistic for high-contention, optimistic for read-heavy with rare conflicts.</p>
                        </div>
                    </div>
                    <div class="question-card">
                        <div class="question"><span class="q-number">Q10</span>
                            <p>Long transaction c√≥ v·∫•n ƒë·ªÅ g√¨?</p>
                        </div>
                        <div class="answer">
                            <ul>
                                <li><strong>Lock holding:</strong> Blocks other transactions longer</li>
                                <li><strong>MVCC overhead:</strong> Old versions can't be purged</li>
                                <li><strong>Undo log growth:</strong> More disk space</li>
                                <li><strong>Deadlock risk:</strong> More time = more chance of conflicts</li>
                                <li><strong>Replication lag:</strong> Large transactions take longer to replicate</li>
                            </ul>
                        </div>
                    </div>
                </div>
            </section>

            <div class="page-navigation">
                <a href="indexing.html" class="nav-btn prev"><i class="fas fa-arrow-left"></i><span>Indexing</span></a>
                <a href="optimization.html" class="nav-btn next"><span>Optimization</span><i
                        class="fas fa-arrow-right"></i></a>
            </div>
        </article>
    </main>

    <button class="back-to-top" id="backToTop"><i class="fas fa-arrow-up"></i></button>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/prism.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/prism/1.29.0/components/prism-sql.min.js"></script>
    <script src="../js/main.js"></script>
</body>

</html>